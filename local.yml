---
- name: Install Ansible Desktop
  hosts: localhost
  connection: local
  become: true
  vars:
    - user: diego
    - home: "/home/{{ user }}"
    - github_username: diegoaldarondo
    - ssh_key: "{{ home }}/.ssh/id_25519"
    - ssh_key_pub: "{{ home }}/.ssh/id_25519.pub"
    - lazygit_dest: "{{ home }}/.local/bin/lazygit"

  tasks:
    - name: install packages
      package:
        name: 
          - htop
          - tmux
          - bat
          - dconf-cli
          - python3-psutil
          - inkscape
          - git
          - tealdeer

    - name: Make .local/bin
      file:
        path: "{{ home }}/.local/bin"
        state: directory
        owner: diego
        group: diego

    - name: Clone fzf repository
      ansible.builtin.git:
        repo: https://github.com/junegunn/fzf.git
        dest: "{{ home }}/.fzf"
        version: master
        depth: 1
      register: clone_result

    - name: Run fzf installation script
      ansible.builtin.shell:
        cmd: "{{ home }}/.fzf/install --all"
      when: clone_result is changed

    - name: Get the latest lazygit version
      ansible.builtin.uri:
        url: https://api.github.com/repos/jesseduffield/lazygit/releases/latest
        method: GET
        return_content: yes
      register: lazygit_release

    - name: Download lazygit tar.gz
      ansible.builtin.get_url:
        url: "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_{{ lazygit_release.json.tag_name | regex_replace('^v', '') }}_Linux_x86_64.tar.gz"
        dest: "{{ home }}/.local/bin/lazygit.tar.gz"
        mode: '0755'

    - name: Extract lazygit from tar.gz
      ansible.builtin.unarchive:
        src: "{{ home }}/.local/bin/lazygit.tar.gz"
        dest: "{{ home }}/.local/bin"
        remote_src: yes
        extra_opts: [--strip-components=1]

    - name: Remove temporary files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/lazygit.tar.gz"
        - "/tmp/lazygit"

    - name: copy wallpaper file
      copy:
        src: files/wallpaper.jpg
        dest: /usr/share/backgrounds/ansible-wallpaper.jpg
        owner: diego
        group: diego

    - name: set wallpaper
      become_user: diego
      dconf:
        key: "/org/gnome/desktop/background/picture-uri"
        value: "'file:///usr/share/backgrounds/ansible-wallpaper.jpg'"
    
    - name: set wallpaper position
      become_user: diego
      dconf:
        key: "/org/gnome/desktop/background/picture-options"
        value: "'zoom'"

    - name: copy bashrc file
      copy:
        src: files/bash/.bashrc
        dest: /home/diego/.bashrc
        owner: diego
        group: diego
    
    - name: copy bash aliases file
      copy:
        src: files/bash/.bash_aliases
        dest: /home/diego/.bash_aliases
        owner: diego
        group: diego
        
    - name: copy .gitconfig file
      copy:
        src: files/git/.gitconfig
        dest: /home/diego/.gitconfig
        owner: diego
        group: diego
 
    - name: copy ssh config file
      copy:
        src: files/ssh/config
        dest: /home/diego/.ssh/config
        owner: diego
        group: diego

    - name: Install vscode deb
      become: yes
      apt:
        deb: https://go.microsoft.com/fwlink/?LinkID=760868
        
    - name: Ensure VSCode settings directory exists
      file:
        path: /home/diego/.config/Code/User
        state: directory
        owner: diego
        group: diego

    - name: Install VSCode extensions
      ansible.builtin.command:
        cmd: "code --install-extension {{ item }}"
      loop:
        - alefragnani.project-manager
        - GitHub.copilot
        - GitHub.copilot-chat
        - ms-python.python
        - ms-python.vscode-pylance
        - ms-toolsai.jupyter
        - ms-toolsai.jupyter-keymap
        - ms-toolsai.jupyter-renderers
        - ms-toolsai.vscode-jupyter-cell-tags
        - ms-toolsai.vscode-jupyter-slideshow
        - ms-vscode-remote.remote-containers
        - ms-vscode-remote.remote-ssh
        - ms-vscode-remote.remote-ssh-edit
        - ms-vscode-remote.remote-wsl
        - ms-vscode-remote.vscode-remote-extensionpack
        - ms-vscode.cmake-tools
        - ms-vscode.cpptools
        - ms-vscode.cpptools-extension-pack
        - ms-vscode.cpptools-themes
        - ms-vscode.remote-explorer
        - ms-vscode.remote-server
        - onnovalkering.vscode-singularity
        - tomoki1207.pdf
        - twxs.cmake
        - zhuangtongfa.material-theme
      become: no

    - name: copy vscode settings
      copy:
        src: files/vscode/settings.json
        dest: /home/diego/.config/Code/User/settings.json
        owner: diego
        group: diego

    - name: copy vscode keybindings
      copy:
        src: files/vscode/keybindings.json
        dest: /home/diego/.config/Code/User/keybindings.json
        owner: diego
        group: diego


      

      
      
